#!/usr/bin/env php
<?php

require "nyansapow.conf.php";
require "$nyansapow_home/lib/Nyansapow.php";

$file = fopen("php://stdin", "r");

while(!feof($file))
{
    $refs = fgets($file);
    // Work only on refs pushed to master
    if(preg_match("/(?<from>[0-9a-f]+) (?<to>[0-9a-f]+) (refs\/heads\/master)/", $refs, $matches))
    {
        if($matches['from'] == '0000000000000000000000000000000000000000')
        {
            echo "Generating a new wiki at `$output_directory`\n";
            exec("git archive master | tar -x -C nyansapow_wiki");
            $wiki = Nyansapow::open('nyansapow_wiki', array('name' => $name));
            $wiki->write($output_directory);
        }
        else 
        {
            $output = popen("git diff-tree --name-only --no-commit-id master", 'r');
            var_dump($output);
            do{
                if($output === false) break;
                $file = fgets($output);
                echo "$file\n";
                sleep(10);
            }while(!feof($output));
            
            //while(!feof($output))
            //{
            //    $file = fgets($output);
            //    echo "$file\n";
            //}
        }
    }
}

