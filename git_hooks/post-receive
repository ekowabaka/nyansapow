#!/usr/bin/env php
<?php

require "nyansapow.conf.php";
require "$nyansapow_home/lib/Nyansapow.php";

$stdin = fopen("php://stdin", "r");

while(!feof($stdin))
{
    $refs = fgets($stdin);
    // Work only on refs pushed to master
    if(preg_match("/(?<from>[0-9a-f]+) (?<to>[0-9a-f]+) (refs\/heads\/master)/", $refs, $matches))
    {
        if($matches['from'] == '0000000000000000000000000000000000000000')
        {
            echo "Generating a new wiki at `$output_directory`\n";
            exec("git archive master | tar -x -C nyansapow_wiki");
            $wiki = Nyansapow::open('nyansapow_wiki', array('name' => $name));
            $wiki->write($output_directory);
        }
        else 
        {
            echo "Updating wiki at `$output_directory`\n";
            exec("git diff-tree --name-only --no-commit-id master", $files);
            foreach($files as $file)
            {
                exec ("git show master:{$file} > nyansapow_wiki/$file");
            }
            $wiki = Nyansapow::open('nyansapow_wiki', array('name' => $name));
            $wiki->write($output_directory, $files);            
        }
    }
}

